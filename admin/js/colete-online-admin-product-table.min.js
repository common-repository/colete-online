"use strict";function _createForOfIteratorHelper(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var a=0,e=function(){};return{s:e,n:function(){return a>=t.length?{done:!0}:{done:!1,value:t[a++]}},e:function(t){throw t},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,l=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return o=t.done,t},e:function(t){l=!0,i=t},f:function(){try{o||null==n.return||n.return()}finally{if(l)throw i}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(n="Object"===n&&t.constructor?t.constructor.name:n)||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,a=new Array(e);n<e;n++)a[n]=t[n];return a}!function(p){p.fn.ColeteOnlineProductTable=function(){var t=[];return this.each(function(){t.push(new p.ColeteOnlineProductTable(p(this)))}),t},p.ColeteOnlineProductTable=function(t){var d=this;this.element=t,this.subscribers={validityChanges:[]};var h=[];this.unique=0,p(t).find("[data-package]").each(function(t,e){var n=p(e),a=+n[0].dataset.package,i=+n.find("[data-package-weight]")[0].dataset.packageWeight,o=+n.find("[data-package-width]")[0].dataset.packageWidth,l=+n.find("[data-package-length]")[0].dataset.packageLength,c=+n.find("[data-package-height]")[0].dataset.packageHeight,r=e.dataset.productMetadata,s=n.find(".coleteonline-product-name").text(),e=n.find(".coleteonline-thumb").html();void 0===h[a]&&(h[a]=[]),h[a].push({el:n,unique:++d.unique,name:s,thumbnail:e,weight:i,width:o,length:l,height:c,metadata:r,manual:!1,editable:!1})}),this.productPackages=h.filter(function(t){return t}),this.initialPackages=JSON.parse(JSON.stringify(this.productPackages)),this.totals=[],this.render(),p(t).find(".coleteonline-add-package").click(this.addPackage.bind(this)),p(t).find(".coleteonline-reset-packages").click(this.resetAndRender.bind(this))},p.ColeteOnlineProductTable.prototype.render=function(){var t=this.productPackages,e=p(this.element).find("tbody");e.empty();for(var n=0,a=0;a<t.length;++a)void 0!==t[a]&&t[a].length&&++n;for(var i=0;i<t.length;++i){var o,l=t[i],c=_createForOfIteratorHelper(l);try{for(c.s();!(o=c.n()).done;){var r,s=o.value;if(s.manual&&1<l.length&&(s.editable=!0),!s.manual||s.editable){for(var d='<select\n          class="coleteonline-package-select-input"\n          name="coleteonline-package-select-input">',h=0;h<=n;++h)d+='<option value="'.concat(h+1,'"\n            ').concat(h+1===i+1?"selected":"","\n          >").concat(h+1,"</option>");d+="</select>",e.append(p('\n          <tr data-package="'.concat(i+1,'"\n            data-unique="').concat(s.unique,'"\n            data-product-metadata="').concat(null===(r=s.metadata)||void 0===r?void 0:r.replace(/"/g,"'"),'"\n            class="product-row">\n            <td class="coleteonline-thumb">\n              ').concat(s.thumbnail,'\n            </td>\n            <td class="coleteonline-product-name">\n              ').concat(s.name,'\n            </td>\n            <td class="coleteonline-package-select">\n              ').concat(d,'\n            </td>\n            <td class="coleteonline-package-weight"\n              data-package-weight="').concat(s.weight,'"\n              data-type="weight"\n            >\n              ').concat(s.editable?'<input type="text" class="coleteonline-package-input coleteonline-package-weight-input" name="coleteonline-package-weight-input" value="'+s.weight+'"/>':s.weight,' kg\n            </td>\n            <td class="coleteonline-package-dimensions width"\n              data-package-width="').concat(s.width,'"\n              data-type="width"\n            >\n              ').concat(s.editable?'<input type="text" class="coleteonline-package-input coleteonline-package-width-input" name="coleteonline-package-width-input" value="'+s.width+'"/>':s.width,' cm\n            </td>\n            <td class="coleteonline-package-dimensions length"\n              data-package-length="').concat(s.length,'"\n              data-type="length"\n            >\n              ').concat(s.editable?'<input type="text" class="coleteonline-package-input coleteonline-package-length-input" name="coleteonline-package-length-input" value="'+s.length+'"/>':s.length,' cm\n            </td>\n            <td class="coleteonline-package-dimensions height"\n              data-package-height="').concat(s.height,'"\n              data-type="height"\n            >\n              ').concat(s.editable?'<input type="text" class="coleteonline-package-input coleteonline-package-height-input" name="coleteonline-package-height-input" value="'+s.height+'"/>':s.height,' cm\n            </td>\n            <td>\n              <button type="button" class="button coleteonline-remove-item">\n                Del\n              </button>\n            </td>\n          </tr>')))}}}catch(t){c.e(t)}finally{c.f()}l.length&&this.renderTotalRow(l,i)}var u=p(this.element);u.find(".coleteonline-order-content-input").val(this.getContent.bind(this)),u.find(".coleteonline-package-select-input").unbind("change"),u.find(".coleteonline-package-select-input").change(this.packageChanged.bind(this)),u.find(".coleteonline-package-input").unbind("change"),u.find(".coleteonline-package-input").change(this.packageCharacteristicsChanged.bind(this)),u.find(".coleteonline-add-item").unbind("click"),u.find(".coleteonline-add-item").click(this.addItem.bind(this)),u.find(".coleteonline-remove-item").unbind("click"),u.find(".coleteonline-remove-item").click(this.removeItem.bind(this)),u.find(".coleteonline-remove-package").unbind("click"),u.find(".coleteonline-remove-package").click(this.removePackage.bind(this)),u.find(".total-row").find("input").unbind("change"),u.find(".total-row").find("input").change(this.totalRowChange.bind(this)),this.setPackageType.bind(this)(),this.validateAllFields()},p.ColeteOnlineProductTable.prototype.renderTotalRow=function(t,e){var n=!1;void 0===this.totals[e]&&(this.totals[e]={weight:0,width:0,length:0,height:0,metadata:[]},n=!0);var a=this.totals[e];if(n){var i,o=_createForOfIteratorHelper(t);try{for(o.s();!(i=o.n()).done;){var l=i.value;a.weight+=l.weight,a.width=Math.max(l.width,a.width),a.length=Math.max(l.length,a.length),a.height=Math.max(l.height,a.height),void 0!==l.metadata&&function(){var e=JSON.parse(l.metadata),t=a.metadata.find(function(t){return t.product.sku===e.product.sku});void 0===t?((t=e).quantity=1,a.metadata.push(t)):++t.quantity}()}}catch(t){o.e(t)}finally{o.f()}}p(this.element).find("tbody").append('\n      <tr class="total-row" data-total-package="'.concat(e,'">\n        <td colspan="3">\n          Total ').concat(e+1,'\n          <button type="button" class="button coleteonline-add-item">\n            +\n          </button>\n        </td>\n        <td>\n          <input type="text"\n            class="coleteonline-package-weight-total-input"\n            name="coleteonline-package-weight-total-input"\n            data-type="weight"\n            value="').concat(a.weight,'"/> kg\n        </td>\n        <td>\n          <input type="text"\n            class="coleteonline-package-width-total-input"\n            name="coleteonline-package-width-total-input"\n            data-type="width"\n            value="').concat(a.width,'"/> cm\n        </td>\n        <td>\n          <input type="text"\n            class="coleteonline-package-length-total-input"\n            name="coleteonline-package-length-total-input"\n            data-type="length"\n            value="').concat(a.length,'"/> cm\n        </td>\n        <td>\n          <input type="text"\n            class="coleteonline-package-height-total-input"\n            name="coleteonline-package-height-total-input"\n            data-type="height"\n            value="').concat(a.height,'"/> cm\n        </td>\n        <td>\n          <button type="button" class="button coleteonline-remove-package">\n            Del\n          </button>\n        </td>\n      </tr>\n    '))},p.ColeteOnlineProductTable.prototype.packageChanged=function(t){var e=p(t.target),n=p(t.target).val(),a=+e.closest("tr")[0].dataset.unique,t=this.findItem(a),e=t.i,a=t.j,t=t.found;this.productPackages[e].splice(a,1),void 0===this.productPackages[n-1]&&(this.productPackages[n-1]=[]),this.productPackages[n-1].push(t),this.productPackages=this.productPackages.filter(function(t){return t&&t.length}),this.totals[e]=void 0,this.render()},p.ColeteOnlineProductTable.prototype.addPackage=function(t){this.productPackages[this.productPackages.length]=[{unique:++this.unique,name:"-",thumbnail:"",weight:1,width:15,length:15,height:15,manual:!0,editable:!1}],this.render()},p.ColeteOnlineProductTable.prototype.addItem=function(t){t=+p(t.target).parents("tr")[0].dataset.totalPackage;this.productPackages[t].push({unique:++this.unique,name:"-",thumbnail:"",weight:1,width:15,length:15,height:15,manual:!0,editable:!1}),this.totals[t]=void 0,this.render()},p.ColeteOnlineProductTable.prototype.removeItem=function(t){var e=+p(t.target).closest("tr")[0].dataset.unique,t=this.findItem(e),e=t.i,t=t.j;this.productPackages[e].splice(t,1),this.productPackages=this.productPackages.filter(function(t){return t&&t.length}),this.totals=[],this.productPackages.length||this.reset(),this.render()},p.ColeteOnlineProductTable.prototype.removePackage=function(t){t=+p(t.target).closest("tr")[0].dataset.totalPackage;this.productPackages.splice(t,1),this.totals.splice(t,1),this.productPackages=this.productPackages.filter(function(t){return t&&t.length}),this.productPackages.length||this.reset(),this.render()},p.ColeteOnlineProductTable.prototype.packageCharacteristicsChanged=function(t){var e=p(t.target),n=+e.val(),a=e.parents("td")[0].dataset.type,t=+e.closest("tr")[0].dataset.unique,e=this.findItem(t),t=e.i;e.found[a]=+n,this.totals[t]=void 0,this.render()},p.ColeteOnlineProductTable.prototype.totalRowChange=function(t){var e=p(t.target),n=+p(e).val(),a=e[0].dataset.type,t=+e.parents("tr")[0].dataset.totalPackage;this.totals[t][a]=n,this.validateDimension(e,a,n),this.notifyValidity()},p.ColeteOnlineProductTable.prototype.validateAllFields=function(){var a=this;p("input.coleteonline-package-input").each(function(t,e){var n=p(e).closest("td")[0].dataset.type;a.validateDimension(e,n,p(e).val())}),p(".total-row input").each(function(t,e){var n=e.dataset.type;a.validateDimension(e,n,p(e).val())}),this.notifyValidity()},p.ColeteOnlineProductTable.prototype.validateDimension=function(t,e,n){"weight"===e&&(isNaN(n)||n<.1?this.addInvalidClass(t):this.removeInvalidClass(t)),"length"!==e&&"width"!==e||(isNaN(n)||n<3?this.addInvalidClass(t):this.removeInvalidClass(t)),"height"===e&&(isNaN(n)||n<1?this.addInvalidClass(t):this.removeInvalidClass(t))},p.ColeteOnlineProductTable.prototype.subscribe=function(t,e){this.subscribers[t].push(e),this.notifyValidity()},p.ColeteOnlineProductTable.prototype.notifyValidity=function(){var t,e=p(this.element).find(".coleteonline-invalid").length,n=p(this.element).next(".coleteonline-packages-errors").first(),a=_createForOfIteratorHelper(this.subscribers.validityChanges);try{for(a.s();!(t=a.n()).done;){var i=t.value;0===e?(i("VALID"),n.hide()):(i("INVALID"),n.show())}}catch(t){a.e(t)}finally{a.f()}this.setPackageType()},p.ColeteOnlineProductTable.prototype.checkValidity=function(){var t,e=p(".coleteonline-packages-table .coleteonline-invalid").length,n=_createForOfIteratorHelper(this.subscribers.validityChanges);try{for(n.s();!(t=n.n()).done;){t.value;return 0===e?"VALID":"INVALID"}}catch(t){n.e(t)}finally{n.f()}},p.ColeteOnlineProductTable.prototype.addInvalidClass=function(t){p(t).addClass("coleteonline-invalid")},p.ColeteOnlineProductTable.prototype.removeInvalidClass=function(t){p(t).removeClass("coleteonline-invalid")},p.ColeteOnlineProductTable.prototype.reset=function(){this.productPackages=JSON.parse(JSON.stringify(this.initialPackages)),this.totals=[]},p.ColeteOnlineProductTable.prototype.resetAndRender=function(){this.reset(),this.render()},p.ColeteOnlineProductTable.prototype.findItem=function(t){var e,n;t:for(e=0;e<this.productPackages.length;++e)for(n=0;n<this.productPackages[e].length;++n)if(this.productPackages[e][n].unique===t)break t;var a=this.productPackages[e][n];if(void 0===a)throw"Package not found error";return{i:e,j:n,found:a}},p.ColeteOnlineProductTable.prototype.getPackagesTotals=function(){return this.totals.filter(function(t){return t})},p.ColeteOnlineProductTable.prototype.getContent=function(){var t,e={},n=_createForOfIteratorHelper(this.productPackages);try{for(n.s();!(t=n.n()).done;){var a,i=_createForOfIteratorHelper(t.value);try{for(i.s();!(a=i.n()).done;){var o=a.value.name;void 0===e[o]&&(e[o]=0),++e[o]}}catch(t){i.e(t)}finally{i.f()}}}catch(t){n.e(t)}finally{n.f()}var l,c=[];for(l in e)e.hasOwnProperty(l)&&(1<e[l]?c.push("".concat(e[l]," x ").concat(l)):c.push(l));var r=c.join(", "),s=p(".coleteonline-order-content-input")[0].dataset,d=s.autocompleteType;return(r="fixed_on_limit"===d&&50<r.length||"fixed"===d?s.autocompleteFixedString:r).substr(0,50)},p.ColeteOnlineProductTable.prototype.setPackageType=function(){p("#coleteonline-order-package-type").val();var t=this.getPackagesTotals(),e=!0;1<(null==t?void 0:t.length)&&(e=!1),1<(null===(t=t[0])||void 0===t?void 0:t.weight)&&(e=!1),console.log({allowEnvelope:e}),console.log(p("#coleteonline-order-package-type option[value='1']")),e?(console.log("should enable"),p("#coleteonline-order-package-type option[value='1']").prop("disabled",!1)):(console.log("should disable"),p("#coleteonline-order-package-type").val(2),p("#coleteonline-order-package-type option[value='1']").prop("disabled",!0)),p("#coleteonline-order-package-type").select2({minimumResultsForSearch:1/0})}}(jQuery);